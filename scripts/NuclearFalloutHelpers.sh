#!/bin/sh
# Eric McCann (Nuclearmistake) 2014

OUTFD=$(ps | grep -v "grep" | grep -o -E "update_binary(.*)" | cut -d " " -f 3); #BIG props to Chainfire
ui_print() { if [ "$OUTFD" != "" ]; then echo "$0: $*" 1>&$OUTFD; fi; return 0; }

backuptool_header() {
mkdir -p /system/addon.d
cat > /system/addon.d/70-gapps.sh <<\NUKE
#!/sbin/sh
#
# /system/addon.d/70-gapps.sh
# Automatically generated by Nuclearmistake's NuclearFallout gapps install script
#
OUTFD=$(ps | grep -v "grep" | grep -o -E "update_binary(.*)" | cut -d " " -f 3); #BIG props to Chainfire
ui_print() { if [ "$OUTFD" != "" ]; then echo "$0: $*" 1>&$OUTFD; fi; return 0; }

. /tmp/backuptool.functions

noisy_restore_file() { ui_print "restore: $*"; restore_file $*; }
noisy_backup_file() { ui_print "backup: $*"; backup_file $*; }
NUKE
if [ $VERBOSE ]; then
echo "RESTORE=noisy_restore_file" >> /system/addon.d/70-gapps.sh
echo "BACKUP=noisy_backup_file" >> /system/addon.d/70-gapps.sh
else
echo "RESTORE=restore_file" >> /system/addon.d/70-gapps.sh
echo "BACKUP=backup_file" >> /system/addon.d/70-gapps.sh
fi
cat >> /system/addon.d/70-gapps.sh <<NUKE
list_files() {
cat <<EOF
NUKE
}

backuptool_footer() {
cat >> /system/addon.d/70-gapps.sh <<\NUKE
EOF
}

case "$1" in
  backup)
    list_files | while read FILE DUMMY; do
      $BACKUP $S/$FILE
    done
  ;;
  restore)
    list_files | while read FILE REPLACEMENT; do
      R=""
      [ -n "$REPLACEMENT" ] && R="$S/$REPLACEMENT"
      [ -f "$C/$S/$FILE" ] && $RESTORE $S/$FILE $R
    done
  ;;
  pre-backup)
    # Stub
  ;;
  post-backup)
    # Stub
  ;;
  pre-restore)
    # Stub
  ;;
  post-restore)
    # Stub
;;
esac
NUKE
}

copy_files() {
  # $1 = temp directory containing files to copy to destination
  # $2 = destination folder
  cd $1
  find . -type d | while read FOLDER; do
    RELATIVE=$(echo $FOLDER | /sbin/busybox sed 's/^\.\///g')
    [ `echo $RELATIVE | wc -c` -gt 0 ] && mkdir -p $2/$RELATIVE
  done
  find . -type f | while read FILE; do
    RELATIVE=$(echo $FILE | /sbin/busybox sed 's/^\.\///g')
    cp $FILE $2/$RELATIVE
    # STRING COMPARE FTW... add files copied to /system to the CM backuptool script
    [ "$2" = "/system" ] && echo $RELATIVE >> /system/addon.d/70-gapps.sh
  done
}
